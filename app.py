import streamlit as st
from langchain_openai import ChatOpenAI
from langchain.schema import SystemMessage, HumanMessage, AIMessage

# ===============================
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
# ===============================
# ãƒšãƒ¼ã‚¸ã®åŸºæœ¬è¨­å®šï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ã‚¢ã‚¤ã‚³ãƒ³ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãªã©ï¼‰
st.set_page_config(
    page_title="Streamlitã¨LangChainã«ã‚ˆã‚‹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ",
    page_icon="ğŸ¤–",
    layout="wide"
)
st.title("Streamlitã¨LangChainã«ã‚ˆã‚‹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ")

# ===============================
# ãƒ¢ãƒ‡ãƒ«ãŠã‚ˆã³APIã®è¨­å®š
# ===============================
# ä½¿ç”¨ã™ã‚‹ç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã®åå‰ï¼ˆä¾‹: lucas2024/gemma-2-2b-jpn-it:q8_0ï¼‰
MODEL = "lucas2024/gemma-2-2b-jpn-it:q8_0"
# APIã®ãƒ™ãƒ¼ã‚¹URLï¼ˆã“ã“ã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ollamaã‚µãƒ¼ãƒãƒ¼ã‚’æŒ‡å®šï¼‰
BASE_URL = "http://localhost:11434/v1"
# APIã‚­ãƒ¼ï¼ˆã“ã“ã§ã¯ã€Œollamaã€ã¨ã„ã†å›ºå®šå€¤ã‚’ä½¿ç”¨ï¼‰
OPENAI_API_KEY = "ollama"
# ç”Ÿæˆæ¸©åº¦ï¼š0.6ã§å¤šæ§˜ãªå¿œç­”ã€0.0ã«è¨­å®šã™ã‚‹ã¨æ±ºå®šè«–çš„ãªå‡ºåŠ›
TEMPERATURE = 0.6

# ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®å½¹å‰²ã‚„æŒ¯ã‚‹èˆã„ã‚’å®šç¾©
SYSTEM_PROMPT = "ã‚ãªãŸã¯å½¹ã«ç«‹ã¤ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚"

# ===============================
# ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¤ã‚³ãƒ³ç”¨SVGï¼ˆ32x32ã®è§’ä¸¸èƒŒæ™¯ã«20x20ã®ã‚¢ã‚¤ã‚³ãƒ³ï¼‰
# ===============================
SYSTEM_ICON = '''
<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
  <!-- èƒŒæ™¯ã®è§’ä¸¸æ­£æ–¹å½¢ï¼ˆè–„ã„ç°è‰²ï¼‰ -->
  <rect x="0" y="0" width="32" height="32" rx="8" fill="#cccccc" />
  <!-- ä¸­å¤®ã«é…ç½®ã•ã‚ŒãŸ20x20ã®ã‚¢ã‚¤ã‚³ãƒ³ -->
  <svg x="6" y="6" width="20" height="20" viewBox="0 -960 960 960" xmlns="http://www.w3.org/2000/svg" fill="#ffffff"><path d="M395-144q-47 0-80-31t-38-77q-57-6-95-48t-38-100.02q0-19.98 4.5-41.48Q153-463 164-480q-10-17.07-15-36.03-5-18.97-5-39.31 0-56.39 37-97.52Q218-694 275-702q2-48 37.04-81t82.99-33q23.97 0 45.97 9t39.46 26q16.54-17 37.87-26t45.44-9Q612-816 647-783q35 33 37 81 57 7 94.5 48.72T816-555q0 20.94-5.5 39.97Q805-496 795-479q12 20 16.5 40t4.5 39.48q0 57.52-38.5 100.02Q739-257 682-252q-5 46-38 77t-80.27 31q-23.17 0-44.95-8.5T480-178q-17 16-39.03 25T395-144Zm121-551.3v431.6q0 19.7 13.92 34.2Q543.84-215 564-215q20 0 33-14t14-34q-19-8-35.07-20.33Q559.86-295.65 547-313q-9-12.48-6.5-26.74Q543-354 555.5-363q12.5-9 26.98-6.76Q596.95-367.53 606-355q10.55 15.03 26.86 23.02 16.3 7.98 35.49 7.98Q700-324 722-346t22-54q0-7-1-13t-3-12q-15.9 9-34.13 13.5Q687.64-407 668-407q-15.3 0-25.65-10.29Q632-427.58 632-442.79t10.35-25.71Q652.7-479 668-479q32 0 54-22t22-53.53q0-31.52-22-53.5Q700-630 666.25-631 655-614 639.5-601T604-581q-14 5-27.5-1.26-13.5-6.27-18.5-20.58-5-14.32 1.5-27.74Q566-644 580.45-649 594-654 603-666.39t9-28.59q0-20.02-13.92-34.52Q584.16-744 564-744q-20.16 0-34.08 14.5Q516-715 516-695.3ZM444-264v-431.31q0-19.69-14.5-34.19Q415-744 394.89-744q-20.12 0-34 14.28Q347-715.44 347-694.76q0 15.76 9 28.26 9 12.5 22.55 17.5 14.45 5 20.95 18.37Q406-617.26 401-603q-5 14-18.5 20.5T355-581q-20-7-35.5-20t-26.76-30Q260-630 238-608t-22 53.02Q216-523 238-501q22 22 54 22 15.3 0 25.65 10.29Q328-458.42 328-443.21t-10.35 25.71Q307.3-407 292-407q-19.6 0-37.8-5-18.2-5-34.2-14-2 6-3 12.67-1 6.66-1 13.33 0 32 22 54t53.65 22q19.19 0 35.49-7.98Q343.45-339.97 354-355q9.29-13.26 24.14-15.63Q393-373 405-364t14.5 24q2.5 15-6.25 27.3Q401-296 384.5-283T348-262q1 20 14 33t32.71 13q20.7 0 35-13.92Q444-243.84 444-264Zm36-215Z"/></svg>
</svg>
'''

# ===============================
# ChatOpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
# ===============================
chat = ChatOpenAI(
    model_name=MODEL,
    openai_api_base=BASE_URL,
    openai_api_key=OPENAI_API_KEY,
    temperature=TEMPERATURE
)

# ===============================
# ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
# ===============================
if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "system", "content": SYSTEM_PROMPT}]

# ===============================
# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›é–¢æ•°ã®å®šç¾©
# ===============================
def convert_messages(messages):
    """
    ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®è¾æ›¸å½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’ã€
    langchainã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆSystemMessage, HumanMessage, AIMessageï¼‰ã®ãƒªã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹é–¢æ•°ã€‚
    
    Parameters:
        messages (list): å„è¾æ›¸ãŒ "role" ã¨ "content" ã‚’ã‚­ãƒ¼ã«æŒã¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã€‚
        
    Returns:
        list: LangChainç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆã€‚
    """
    converted = []
    for msg in messages:
        if msg["role"] == "system":
            converted.append(SystemMessage(content=msg["content"]))
        elif msg["role"] == "user":
            converted.append(HumanMessage(content=msg["content"]))
        elif msg["role"] == "assistant":
            converted.append(AIMessage(content=msg["content"]))
    return converted

# ===============================
# æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
# ===============================
for message in st.session_state.messages:
    if message["role"] == "system":
        # ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€ã‚«ã‚¹ã‚¿ãƒ SVGã‚¢ã‚¤ã‚³ãƒ³ã‚’æŒ‡å®š
        with st.chat_message("system", avatar=SYSTEM_ICON):
            st.markdown(message["content"])
    else:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

# ===============================
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›å–å¾—ã¨å¿œç­”ç”Ÿæˆ
# ===============================
if prompt := st.chat_input("AIã«èããŸã„ã“ã¨ã‚’æ›¸ã„ã¦ã­"):
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã«è¿½åŠ ã—ã€è¡¨ç¤º
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)
    
    # ä¸€é€£ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’LLMã«é€ä¿¡ã—ã¦å¿œç­”ã‚’å–å¾—
    messages_for_model = convert_messages(st.session_state.messages)    
    response = chat.invoke(messages_for_model)

    # å¿œç­”ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã«è¿½åŠ ã—ã€è¡¨ç¤º
    st.session_state.messages.append({"role": "assistant", "content": response.content})
    with st.chat_message("assistant"):
        st.markdown(response.content)
